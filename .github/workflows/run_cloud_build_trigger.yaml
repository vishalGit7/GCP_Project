name: 'Run CLoud Build Trigger for New version of Cloud Run'

on:
  workflow_dispatch: 

jobs:
  build:
    name: Assign Variable Values
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
    
    steps:
      - uses: actions/checkout@v3
      - name: Set Variable Values
        run: | 
          TRIGGER_NAME=my-cloudbuild-trigger
          REGION=us-central1
          BRANCH_NAME=cr_nihilient
          echo "::set-output name=trigger_name::$TRIGGER_NAME"
          echo "::set-output name=region::$REGION"
          echo "::set-output name=branch::$BRANCH_NAME"



  deploy:
    name: 'Trigger Cloud Build'
    runs-on: ubuntu-latest  # Run the workflow on an Ubuntu runner

    defaults:
      run:
        shell: bash  # Use the Bash shell


    steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:

      #   workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
      #   service_account: 'my-service-account@my-project.iam.gserviceaccount.com'
        credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}


    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: '>= 363.0.0'
      env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

    # - name: Set trigger details
    #   run: |
    #       TRIGGER_NAME= my-cloudbuild-trigger            
    #       REGION=us-central1         
    #       BRANCH_NAME=cr_nihilient   
    #       echo "Trigger name: $TRIGGER_NAME"
    #       echo "Region: $REGION"
    #       echo "Branch name: $BRANCH_NAME"


    - name: Run gcloud builds triggers run command
      env:
        REGION: ${{ env.REGION }}  # Pass region from previous step
        BRANCH_NAME: ${{ env.BRANCH_NAME }}  # Pass branch name from previous step
      run: |
          gcloud builds triggers run "${steps.Set_Variable_Values.trigger_name}" \
            --region="${steps.Set_Variable_Values.region}" \
            --branch="${steps.Set_Variable_Values.branch}"

    # - name: 'Use gcloud CLI'
    #   run: |
    #       gcloud builds triggers run ${TRIGGER_NAME \
    #      --region=REGION \
    #      --branch=BRANCH_NAME \
    #      --substitutions=SUBSTITUTION_VAR=SUBSTITUTION_VALUE
    #   env:
    #       GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}